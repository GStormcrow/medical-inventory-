{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Medications - NASA Medical Inventory{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-pages.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Manage Medications</h1>
        <p>Add medications and upload reference images</p>
    </div>

    <div id="alertBox" class="alert"></div>

    <div class="add-section">
        <h2>Add New Medication</h2>
        <form id="medicationForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label for="name">Medication Name *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="current_quantity">Current Quantity *</label>
                    <input type="number" id="current_quantity" name="current_quantity" min="0" required>
                </div>

                <div class="form-group">
                    <label for="minimum_quantity">Minimum Quantity *</label>
                    <input type="number" id="minimum_quantity" name="minimum_quantity" min="0" required>
                </div>

                <div class="form-group">
                    <label for="expiration_date">Expiration Date</label>
                    <input type="date" id="expiration_date" name="expiration_date">
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Add Medication</button>
        </form>
    </div>

    <div class="medication-list">
        <h2>All Medications</h2>
        <div class="medication-grid" id="medicationGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    // Preview image before upload
    document.getElementById('pill_image').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }
    });

    // Submit form
    document.getElementById('medicationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/api/medications/add/', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showAlert('✓ Medication added successfully!', 'success');
                this.reset();
                document.getElementById('imagePreview').innerHTML = '';
                loadMedications();
            } else {
                showAlert('✗ Error: ' + (data.message || 'Failed to add medication'), 'error');
            }
        } catch (error) {
            showAlert('✗ Connection error: ' + error.message, 'error');
        }
    });

    // Load medications
    async function loadMedications() {
        try {
            const response = await fetch('/api/medications/list/');
            const data = await response.json();

            const grid = document.getElementById('medicationGrid');
            
            if (data.medications && data.medications.length > 0) {
                grid.innerHTML = data.medications.map(med => {
                    let stockClass = 'stock-good';
                    let stockText = 'Normal';
                    
                    if (med.status === 'OUT') {
                        stockClass = 'stock-out';
                        stockText = 'Out of Stock';
                    } else if (med.status === 'CRITICAL') {
                        stockClass = 'stock-out';
                        stockText = 'Critical';
                    } else if (med.status === 'LOW') {
                        stockClass = 'stock-low';
                        stockText = 'Low Stock';
                    }

                    return `
                        <div class="medication-card">
                            <div class="medication-info">
                                <div class="medication-name">${med.name}</div>
                                <div class="medication-details">
                                    <div><strong>Stock:</strong> ${med.current_quantity} units</div>
                                    <div><strong>Minimum:</strong> ${med.minimum_quantity} units</div>
                                    ${med.expiration_date ? `<div><strong>Expires:</strong> ${med.expiration_date}</div>` : ''}
                                </div>
                                <span class="stock-status ${stockClass}">${stockText}</span>
                                <div class="card-actions">
                                    <button class="btn btn-secondary" onclick="editMedication(${med.id})">Edit</button>
                                    <button class="btn btn-secondary" onclick="deleteMedication(${med.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                grid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center;">No medications added yet.</p>';
            }
        } catch (error) {
            console.error('Error loading medications:', error);
        }
    }

    function updateImage(medicationId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);
            formData.append('medication_id', medicationId);

            try {
                const response = await fetch('/api/medications/update-image/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('✓ Image updated successfully!', 'success');
                    loadMedications();
                } else {
                    showAlert('✗ Error: ' + (data.message || 'Failed to update image'), 'error');
                }
            } catch (error) {
                showAlert('✗ Connection error: ' + error.message, 'error');
            }
        };
        input.click();
    }

    function editMedication(medicationId) {
        window.location.href = `/inventory/${medicationId}/`;
    }

    async function deleteMedication(medicationId) {
        if (!confirm('Are you sure you want to delete this medication?')) return;

        try {
            const response = await fetch(`/api/medications/delete/${medicationId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('✓ Medication deleted successfully', 'success');
                loadMedications();
            } else {
                showAlert('✗ Error: ' + (data.message || 'Failed to delete'), 'error');
            }
        } catch (error) {
            showAlert('✗ Connection error: ' + error.message, 'error');
        }
    }

    function showAlert(message, type) {
        const alert = document.getElementById('alertBox');
        alert.textContent = message;
        alert.className = `alert ${type} show`;
        
        setTimeout(() => {
            alert.classList.remove('show');
        }, 5000);
    }

    // Load medications on page load
    loadMedications();
</script>
{% endblock %}