{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Astronauts - NASA Medical Inventory{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-pages.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Manage Astronauts</h1>
        <p>Add astronauts and register their facial data</p>
    </div>

    <div id="alertBox" class="alert"></div>

    <div class="add-section">
        <h2>Add New Astronaut</h2>
        <form id="astronautForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label for="name">Full Name *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="astronaut_id">Astronaut ID *</label>
                    <input type="text" id="astronaut_id" name="astronaut_id" placeholder="NASA001" required>
                </div>

                <div class="form-group">
                    <label for="password">Password (for admin access)</label>
                    <input type="password" id="password" name="password" placeholder="Leave blank for default">
                </div>
            </div>

            <div class="form-group">
                <label for="photo">Face Photo (for recognition) *</label>
                <input type="file" id="photo" name="photo" accept="image/*" required>
                <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.85rem; margin-top: 5px;">
                    Clear, front-facing photo with good lighting. Face should be clearly visible.
                </p>
                <div id="photoPreview" class="file-preview"></div>
            </div>

            <button type="submit" class="btn btn-primary">Add Astronaut</button>
        </form>
    </div>

    <div class="astronaut-list">
        <h2>All Astronauts</h2>
        <div class="astronaut-grid" id="astronautGrid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
<script>
    // Preview photo before upload
    document.getElementById('photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('photoPreview');
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="file-info">${file.name} (${(file.size / 1024).toFixed(1)} KB)</div>
                `;
            };
            reader.readAsDataURL(file);
        }
    });

    // Submit form
    document.getElementById('astronautForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/api/astronauts/add/', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showAlert('✓ Astronaut added successfully! Face encoding registered.', 'success');
                this.reset();
                document.getElementById('photoPreview').innerHTML = '';
                loadAstronauts();
            } else {
                showAlert('✗ Error: ' + (data.message || 'Failed to add astronaut'), 'error');
            }
        } catch (error) {
            showAlert('✗ Connection error: ' + error.message, 'error');
        }
    });

    // Load astronauts
    async function loadAstronauts() {
        try {
            const response = await fetch('/api/astronauts/list/');
            const data = await response.json();

            const grid = document.getElementById('astronautGrid');
            
            if (data.astronauts && data.astronauts.length > 0) {
                grid.innerHTML = data.astronauts.map(astronaut => `
                    <div class="astronaut-card">
                        <img src="${astronaut.photo_url || '/static/default-avatar.png'}" 
                             alt="${astronaut.name}" 
                             class="astronaut-photo"
                             onerror="this.src='/static/default-avatar.png'">
                        <div class="astronaut-info">
                            <div class="astronaut-name">${astronaut.name}</div>
                            <div class="astronaut-id">${astronaut.astronaut_id}</div>
                            <span class="face-status ${astronaut.has_face_encoding ? 'encoded' : 'no-encoding'}">
                                ${astronaut.has_face_encoding ? '✓ Face Encoded' : '✗ No Encoding'}
                            </span>
                            <div class="card-actions">
                                ${!astronaut.has_face_encoding ? 
                                    `<button class="btn btn-secondary" onclick="updateFace(${astronaut.id})">Add Face</button>` : 
                                    `<button class="btn btn-secondary" onclick="updateFace(${astronaut.id})">Update Face</button>`
                                }
                                <button class="btn btn-secondary" onclick="deleteAstronaut(${astronaut.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                grid.innerHTML = '<p style="color: rgba(255, 255, 255, 0.5); text-align: center;">No astronauts added yet.</p>';
            }
        } catch (error) {
            console.error('Error loading astronauts:', error);
        }
    }

    function updateFace(astronautId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('photo', file);
            formData.append('astronaut_id', astronautId);

            try {
                const response = await fetch('/api/astronauts/update-face/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('✓ Face encoding updated successfully!', 'success');
                    loadAstronauts();
                } else {
                    showAlert('✗ Error: ' + (data.message || 'Failed to update face'), 'error');
                }
            } catch (error) {
                showAlert('✗ Connection error: ' + error.message, 'error');
            }
        };
        input.click();
    }

    async function deleteAstronaut(astronautId) {
        if (!confirm('Are you sure you want to delete this astronaut?')) return;

        try {
            const response = await fetch(`/api/astronauts/delete/${astronautId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('✓ Astronaut deleted successfully', 'success');
                loadAstronauts();
            } else {
                showAlert('✗ Error: ' + (data.message || 'Failed to delete'), 'error');
            }
        } catch (error) {
            showAlert('✗ Connection error: ' + error.message, 'error');
        }
    }

    function showAlert(message, type) {
        const alert = document.getElementById('alertBox');
        alert.textContent = message;
        alert.className = `alert ${type} show`;
        
        setTimeout(() => {
            alert.classList.remove('show');
        }, 5000);
    }

    // Load astronauts on page load
    loadAstronauts();
</script>
{% endblock %}